(()=>{"use strict";addEventListener("fetch",(e=>{"OPTIONS"!==e.request.method?new URL(e.request.url).pathname.startsWith("/images/")?e.respondWith(async function(e){if("OPTIONS"===e.method)return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers"}});const t=new URL(e.url),s=decodeURIComponent(t.pathname.replace("/images/","")),o=await MY_R2_BUCKET.get(s);if(!o)return new Response("Image not found",{status:404});const n=new Headers;return o.writeHttpMetadata(n),n.set("Cache-Control","public, max-age=3600"),n.set("Content-Type","image/png"),n.set("Access-Control-Allow-Origin","*"),n.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),n.set("Access-Control-Allow-Headers","Content-Type, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers"),new Response(o.body,{headers:n})}(e.request)):e.respondWith(async function(e){if("OPTIONS"===e.method)return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers"}});if("POST"!==e.method)return new Response("Method Not Allowed",{status:405});try{const t=await e.json(),{data:s,width:o,height:n}=t;if(!s||!o||!n)return new Response("Invalid request format. Data, width, and height are required.",{status:400});const r="data:image/png;base64,";if(!s.startsWith(r))return new Response("Invalid image data format",{status:400});const l=s.slice(r.length),a=Uint8Array.from(atob(l),(e=>e.charCodeAt(0))),c=`ogp-image-${Date.now()}-${o}x${n}.png`;await MY_R2_BUCKET.put(c,a,{httpMetadata:{contentType:"image/png"},customMetadata:{uploaded:(new Date).toISOString(),width:o.toString(),height:n.toString()}});const i=`${new URL(e.url).origin}/images/${encodeURIComponent(c)}`,A=new Headers;return A.set("Content-Type","application/json"),A.set("Access-Control-Allow-Origin","*"),A.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),A.set("Access-Control-Allow-Headers","Content-Type, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers"),new Response(JSON.stringify({url:i}),{headers:A})}catch(e){return console.error("Error processing request:",e),new Response("Error processing request: "+(e.message||e),{status:500})}}(e.request)):e.respondWith(new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Access-Control-Allow-Origin, Access-Control-Allow-Methods, Access-Control-Allow-Headers"}}))}))})();